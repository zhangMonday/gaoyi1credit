<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜ä¸€1ç­å­¦åˆ†è®¡ç®—ç³»ç»Ÿ</title>

    <!-- æ ·å¼ -->
    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        .credit-increase {
            color: green;
            font-weight: bold;
        }

        .credit-decrease {
            color: red;
            font-weight: bold;
        }

        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }

        .slider-label {
            margin-bottom: 5px;
            display: block;
            font-weight: 500;
        }

        .rank-up {
            color: green;
        }

        .rank-down {
            color: red;
        }

        .rank-neutral {
            color: gray;
        }

        /* å›¾è¡¨å®¹å™¨æ ·å¼ */
        .chart-container {
            margin-top: 40px;
        }

        /* è¡¨æ ¼æ ·å¼ */
        table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }

        th, td {
            text-align: center;
            padding: 8px;
            border: 1px solid #dee2e6;
        }

        th {
            background-color: #f1f1f1;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .slider-label {
                font-size: 14px;
            }
            .table-responsive {
                max-height: 400px;
            }
            h1 {
                font-size: 1.5rem;
            }
        }

        /* æ›´æ–°æ—¥å¿— */
        #update-log .list-group-item {
            font-size: 0.95rem;
        }

        .alert-info {
            font-size: 0.95rem;
        }

        /* é“¾æ¥æŒ‰é’®æ ·å¼ */
        .btn-outline-primary img {
            vertical-align: middle;
        }

        /* æ’åå˜åŒ–é¢œè‰² */
        .rank-change.rank-up {
            color: green;
        }

        .rank-change.rank-down {
            color: red;
        }

        .rank-change.rank-neutral {
            color: gray;
        }

        /* è¿›æ­¥æ’åºè¡¨æ ¼æ ·å¼ */
        .improvement-table {
            margin-top: 40px;
        }
    </style>

    <!-- å»¶è¿ŸåŠ è½½éå…³é”®CSSï¼šFont Awesome å’Œ Bootstrap 5.3.0 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"></noscript>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></noscript>

    <!-- å»¶è¿ŸåŠ è½½ JavaScript åº“ï¼Œç¡®ä¿é¡ºåº -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" defer></script>

</head>
<body>

    <div class="container">
        <h1 class="mb-4 text-center">é«˜ä¸€1ç­å­¦åˆ†è®¡ç®—ç³»ç»Ÿ(V2.1.1) BY ZZY</h1>

        <!-- æ•°æ®å¯¼å…¥å¯¼å‡º -->
        <div class="mb-4 d-flex justify-content-between">
            <div>
                <button class="btn btn-success me-2" id="import-excel"><i class="fa fa-file-import"></i> ä»Excelå¯¼å…¥æˆç»©</button>
                <button class="btn btn-info" id="export-results"><i class="fa fa-file-export"></i> å¯¼å‡ºè®¡ç®—ç»“æœä¸ºExcel</button>
            </div>
            <div>
                <button class="btn btn-secondary" id="download-template"><i class="fa fa-download"></i> ä¸‹è½½Excelæ¨¡æ¿</button>
                <!-- è§£é‡ŠæŒ‰é’® -->
                <button class="btn btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#algorithmExplanation" aria-expanded="false" aria-controls="algorithmExplanation">
                    <i class="fa fa-info-circle"></i> å­¦åˆ†ç®—æ³•è¯´æ˜
                </button>
            </div>
        </div>

        <div class="collapse mb-4" id="algorithmExplanation">
            <div class="card card-body">
                <h5>å­¦åˆ†è®¡ç®—ç®—æ³•è¯´æ˜</h5>
                <p>æœ¬ç³»ç»Ÿæ ¹æ®ä»¥ä¸‹è§„åˆ™è®¡ç®—å­¦åˆ†å¢åŠ ï¼š</p>
                <ol>
                    <li><strong>æ€»åˆ†æ’ååŠ åˆ†</strong>ï¼š
                        <ul>
                            <li>æ€»åˆ†ç¬¬ä¸€åï¼ŒåŠ 8åˆ†</li>
                            <li>æ€»åˆ†2-10åï¼ŒåŠ 5åˆ†</li>
                        </ul>
                    </li>
                    <li><strong>ä¸‰ç§‘æ€»åˆ†æ’ååŠ åˆ†</strong>ï¼š
                        <ul>
                            <li>ä¸‰ç§‘ï¼ˆè¯­æ–‡æ•°å­¦è‹±è¯­ï¼‰æ€»åˆ†å‰åï¼ŒåŠ 3åˆ†</li>
                        </ul>
                    </li>
                    <li><strong>å•ç§‘æ’ååŠ åˆ†</strong>ï¼š
                        <ul>
                            <li>å•ç§‘å‰äº”ï¼ŒåŠ 2åˆ†</li>
                            <li>å•ç§‘6-10åï¼ŒåŠ 1åˆ†</li>
                        </ul>
                    </li>
                    <li><strong>è¿›æ­¥æ’ååŠ åˆ†</strong>ï¼š
                        <ul>
                            <li>æ€»åˆ†æ¯”ä¸Šä¸€æ¬¡è€ƒè¯•è¿›æ­¥1-10åï¼ŒåŠ 1åˆ†</li>
                            <li>æ€»åˆ†æ¯”ä¸Šä¸€æ¬¡è€ƒè¯•è¿›æ­¥11-20åï¼ŒåŠ 2åˆ†</li>
                            <li>æ€»åˆ†æ¯”ä¸Šä¸€æ¬¡è€ƒè¯•è¿›æ­¥21-30åï¼ŒåŠ 3åˆ†</li>
                            <li>ä¸‰ç§‘æ¯”ä¸Šä¸€æ¬¡è€ƒè¯•è¿›æ­¥1-10åï¼ŒåŠ 1åˆ†</li>
                            <li>ä¸‰ç§‘æ¯”ä¸Šä¸€æ¬¡è€ƒè¯•è¿›æ­¥11-20åï¼ŒåŠ 2åˆ†</li>
                            <li>ä¸‰ç§‘æ¯”ä¸Šä¸€æ¬¡è€ƒè¯•è¿›æ­¥21-30åï¼ŒåŠ 3åˆ†</li>
                        </ul>
                    </li>
                </ol>
                <p>æ¯ä¸ªäººåŠ åˆ†ä¸å¾—è¶…è¿‡15åˆ†ã€‚</p>
            </div>
        </div>

        <!-- æˆç»©è¾“å…¥è¡¨æ ¼ -->
        <div class="table-responsive mb-4">
            <strong style="color:red">åå•å¦‚æœæ²¡åŠ è½½å‡ºæ¥ï¼Œè¯•ç€å¤šåˆ·æ–°å‡ æ¬¡æˆ–æ¸…é™¤æµè§ˆå™¨ç¼“å­˜</strong>
            <table class="table table-bordered table-hover" id="scores-table">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>å­¦å·</th>
                        <th>å§“å</th>
                        <th>ä¸Šæ¬¡æ€»æˆç»©</th>
                        <th>ä¸Šæ¬¡ä¸‰ç§‘æˆç»©</th>
                        <th>è¯­æ–‡å¾—åˆ†</th>
                        <th>æ•°å­¦å¾—åˆ†</th>
                        <th>è‹±è¯­å¾—åˆ†</th>
                        <th>ç‰©ç†å¾—åˆ†</th>
                        <th>åŒ–å­¦å¾—åˆ†</th>
                        <th>ç”Ÿç‰©å¾—åˆ†</th>
                        <th>å†å²å¾—åˆ†</th>
                        <th>æ”¿æ²»å¾—åˆ†</th>
                        <th>åœ°ç†å¾—åˆ†</th>
                        <th>æ€»åˆ†</th>
                        <th>æ€»åˆ†æ’å</th>
                        <th>ä¸‰ç§‘æ€»åˆ†</th>
                        <th>ä¸‰ç§‘æ’å</th>
                        <th>æ€»åˆ†åæ¬¡å˜åŒ–</th>
                        <th>ä¸‰ç§‘åæ¬¡å˜åŒ–</th>
                        <th>æ€»åˆ†åæ¬¡åŠ åˆ†</th>
                        <th>ä¸‰ç§‘åæ¬¡åŠ åˆ†</th>
                        <th>å•ç§‘åŠ åˆ†</th>
                        <th>è¿›æ­¥åŠ åˆ†</th>
                        <th>æ€»å…±åŠ åˆ†</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- åŠ¨æ€ç”Ÿæˆè¡¨æ ¼è¡Œ -->
                </tbody>
            </table>
        </div>

        <!-- è®¡ç®—æŒ‰é’® -->
        <div class="mb-4 text-center">
            <button class="btn btn-primary btn-lg" id="calculate-credits"><i class="fa fa-calculator"></i> è®¡ç®—å­¦åˆ†</button>
        </div>

        <!-- å­¦åˆ†ç»“æœå±•ç¤ºæç¤º -->
        <div id="results-section">
            <!-- ç»“æœå°†åœ¨æ­¤å¤„æ˜¾ç¤º -->
        </div>

        <!-- è¿›æ­¥æ’ååˆ—è¡¨ -->
        <div class="improvement-table">
            <h3 class="text-center">æ€»åˆ†è¿›æ­¥æ’å</h3>
            <table class="table table-bordered table-hover" id="total-improvement-table">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>æ’å</th>
                        <th>å§“å</th>
                        <th>è¿›æ­¥åæ¬¡</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- åŠ¨æ€ç”Ÿæˆè¡¨æ ¼è¡Œ -->
                </tbody>
            </table>
        </div>

        <div class="improvement-table">
            <h3 class="text-center">ä¸‰ç§‘è¿›æ­¥æ’å</h3>
            <table class="table table-bordered table-hover" id="three-improvement-table">
                <thead class="table-light sticky-top">
                    <tr>
                        <th>æ’å</th>
                        <th>å§“å</th>
                        <th>è¿›æ­¥åæ¬¡</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- åŠ¨æ€ç”Ÿæˆè¡¨æ ¼è¡Œ -->
                </tbody>
            </table>
        </div>

        <!-- å›¾è¡¨å®¹å™¨ -->
        <div class="chart-container">
            <h3 class="text-center">å­¦åˆ†å˜åŒ–åˆ†å¸ƒå›¾ï¼ˆä¼šåœ¨è®¡ç®—å‡ºå­¦åˆ†åæ˜¾ç¤ºï¼‰</h3>
            <canvas id="creditChart"></canvas>
        </div>
    </div>
    <!-- æ›´æ–°æ—¥å¿— -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>æ›´æ–°æ—¥å¿—</h5>
        </div>
        <div class="card-body">
            <ul class="list-group list-group-flush" id="update-log">
                <li class="list-group-item">
                    <strong>2024-10-19 Beta</strong>: å»ºç«‹å­¦åˆ†è®¡ç®—æ¨¡å‹ï¼Œç¨‹åºdemo
                </li>
                <li class="list-group-item">
                    <strong>2024-10-21 V1.0.0</strong>: æ­£å¼ç‰ˆå‘å¸ƒï¼š1.æ·»åŠ æ•°æ®éšç§å£°æ˜å’Œæºä»£ç é“¾æ¥ï¼Œä¼˜åŒ–ç•Œé¢ï¼›2.é»˜è®¤æ›´åˆç†çš„æƒé‡ï¼›3.ä¼˜åŒ–ç®—æ³•ï¼›4.ä¿®å¤å­¦åˆ†é™åˆ¶åœ¨ä¸¤åˆ†çš„bugï¼ŒåŸå› åˆ†æï¼šdemoä¸­ç”¨äºæµ‹è¯•çš„æ•°å€¼2åœ¨åæœŸä¿®æ”¹ä¸­åªæ”¹äº†htmlä¸­çš„æ•°å€¼ï¼Œjsä¸­çš„æ•°å€¼æ²¡å˜ï¼Œå¯¼è‡´è®¡ç®—æ—¶æœ€å¤§å­¦åˆ†é™åˆ¶ä»ä¸º2ï¼›5.ä¼˜åŒ–ç½‘é¡µåŠ è½½é€Ÿåº¦ï¼Œä¿®æ”¹å†…å®¹åŒ…æ‹¬ä½†ä¸é™äºä½¿ç”¨æ›´è½»é‡çº§çš„webpæ ¼å¼ï¼Œ å»¶è¿ŸåŠ è½½jsï¼ŒLazy loadingï¼›6.å¼€æ”¾æºä»£ç 
                </li>
                <li class="list-group-item">
                    <strong>2024-10-26 V1.2.0</strong>: 1.uiå‡çº§ 2.å»¶è¿ŸåŠ è½½ä¸€äº›ä¸æ˜¯ç«‹å³éœ€è¦çš„åº“ï¼ŒåŠ å¿«ç½‘é¡µç»˜åˆ¶é€Ÿåº¦ 3.ç”±GitHub+Vercelçš„æ‰˜ç®¡ç­–ç•¥æ”¹ä¸ºé˜¿é‡Œäº‘ossï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰ä½œä¸ºæœåŠ¡å™¨ï¼Œç½‘é¡µæ‰“å¼€é€Ÿåº¦å¤§å¹…åº¦æå‡
                </li>
                 <li class="list-group-item">
                    <strong>2024-10-27 V1.2.1</strong>:ä¿®å¤æ— æ³•æ­£å¸¸å¯¼å‡ºexcelçš„bug
                </li>
                <li class="list-group-item">
                    <strong>2024-10-28 V1.2.4</strong>:1.ä¼˜åŒ–ä»£ç æ’ç‰ˆ;2.è§£å†³å¯¼å‡ºçš„excelä¸­æ— æˆç»©çš„é—®é¢˜;3.è§£å†³ç®—æ³•å›¾ç¤ºç‚¹å¼€åæ²¡æ³•å…³é—­çš„é—®é¢˜
                </li>
                <li class="list-group-item">
                    <strong>2024-11-2 V1.3.0</strong>:1.ä¼˜åŒ–æ“ä½œé€»è¾‘ï¼Œæ›´æ”¹è®¾ç½®åç«‹å³ç”Ÿæ•ˆè€Œä¸éœ€è¦å†ç‚¹å‡»åº”ç”¨è®¾ç½®æŒ‰é’®ï¼›2.è§£é‡Šæƒé‡é¡µï¼›3.ä¿®å¤äº†ä¸Šæ¬¡ç¼ºè€ƒè€Œæ­¤æ¬¡ä¸ç¼ºè€ƒä½†æ’åæ— æ³•è®¡ç®—çš„é—®é¢˜
                </li>
                <li class="list-group-item">
                    <strong>2024-11-3 V1.3.5</strong>:1.ä¿®å¤v1.3.0æ›´æ–°å¯¼è‡´çš„æƒé‡åŠ è½½é™·å…¥æ­»å¾ªç¯è€Œæ‹–æ…¢ç½‘é¡µåŠ è½½é€Ÿåº¦çš„é—®é¢˜
                </li>
                <li class="list-group-item">
                    <strong>2024-11-6 V1.4.0</strong>:ä¸ºæ–¹ä¾¿è€ƒåœºæ˜¾ç¤ºæ—¶é—´ï¼Œæ–°å†™äº†ä¸ªæ—¶é’Ÿçš„ç½‘é¡µï¼Œé“¾æ¥åœ¨é¡µé¢æœ€åå¼€æºå¤„
                </li>
               </ul>
        </div>
    </div>

    <div class="alert alert-info mt-4" role="alert">
        <p>æœ¬ç³»ç»Ÿä¿è¯å…¬å¹³å…¬æ­£ï¼Œæ‰€æœ‰è®¡ç®—å‡åœ¨æœ¬åœ°è¿›è¡Œï¼Œä¸ä¼šä»¥ä»»ä½•å½¢å¼æ”¶é›†æˆ–ä¸Šä¼ ä»»ä½•æ•°æ®ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºæˆç»©å’Œæ’åï¼‰ç½‘é¡µä¸€æ—¦åˆ·æ–°æˆ–å…³é—­ï¼Œæ•°æ®ç«‹å³é”€æ¯ã€‚è¿˜ä¸ä¿¡ï¼Ÿå¯ç­‰å¾…ç½‘é¡µåŠ è½½å®Œæˆåï¼Œæ–­ç½‘è¾“å…¥æˆç»©è®¡ç®—ã€‚é¡¹ç›®å·²å¼€æºï¼Œæ¬¢è¿æ£€æŸ¥æºä»£ç ã€æå‡ºissueï¼Œå‚ä¸å¼€å‘ã€‚</p>
        <a href="https://github.com/zhangMonday/gaoyi1credit" target="_blank" class="btn btn-outline-primary mt-2">
            <img src="github.svg" alt="GitHub" style="width: 16px; height: 16px; margin-right: 4px;">
            å¼€æºåœ°å€
        </a>
        <a href="https://credit1.zhangmonday.top/clock.html" target="_blank" class="btn btn-outline-primary mt-2">
            <img src="https://credit1.zhangmonday.top/icons/icon-192.png" alt="clock" style="width: 16px; height: 16px; margin-right: 4px;">
            è€ƒåœºæ—¶é—´
        </a>
    </div>

    <!-- ä¸»è„šæœ¬ -->
    <script defer>
        /* 
             â–ƒâ–†â–ˆâ–‡â–„â––
            â–Ÿâ—¤â––ã€€ã€€ã€€â—¥â–ˆâ–
            â—¢â—¤ã€€ â–ã€€ã€€ã€€ã€€â–â–‰
            â–—â—¤ã€€ã€€ã€€â–‚ã€€â–—â––ã€€ã€€â–•â–ˆâ–
            â—¤ã€€â–—â–…â––â—¥â–„ã€€â–€â—£ã€€ã€€â–ˆâ–Š
            â–ã€€â–•â–â—¥â––â—£â—¤ã€€ã€€ã€€ã€€â—¢â–ˆâ–ˆ
            â–ˆâ—£ã€€â—¥â–…â–ˆâ–€ã€€ã€€ã€€ã€€â–â–ˆâ–ˆâ—¤
            â–â–ˆâ–™â–‚ã€€ã€€ã€€ â—¢â–ˆâ–ˆâ—¤
            â—¥â–ˆâ–ˆâ–£ã€€ã€€ã€€ã€€â—¢â–„â—¤
                 â–€â–ˆâ–ˆâ–…â–‡â–€
        */

        // æœ¬ç­åå•
        const students = [
            { id: 1, name: "è”¡å…‹ä¸€" },
            { id: 2, name: "é™ˆçˆ±å˜‰" },
            { id: 3, name: "é™ˆåº†éš†" },
            { id: 4, name: "ç¨‹åšæ¶µ" },
            { id: 5, name: "ä¸é™ˆæµ©" },
            { id: 6, name: "èŒƒé¥¶" },
            { id: 7, name: "å†¯è°¨è¿œ" },
            { id: 8, name: "ä»˜ä¸–é‘«" },
            { id: 9, name: "éƒ­é™ˆå‡¯" },
            { id: 10, name: "èƒ¡è˜æ¡" },
            { id: 11, name: "å®¦æ™“è¯š" },
            { id: 12, name: "çºªè£•éŸ¬" },
            { id: 13, name: "è“å¤©å®‡" },
            { id: 14, name: "æä½³å¦®" },
            { id: 15, name: "æå®‡æ¶µ" },
            { id: 16, name: "åˆ˜å®¸ç®" },
            { id: 17, name: "å¢é’°æ¶›" },
            { id: 18, name: "é™†ä¸€æ¶µ" },
            { id: 19, name: "æ¯›è¯­é¦¨" },
            { id: 20, name: "ç©†å­æµ©" },
            { id: 21, name: "æ½˜è£è§" },
            { id: 22, name: "æˆšå¤©å¨‡" },
            { id: 23, name: "é’±æ¹˜é’°" },
            { id: 24, name: "æ²ˆç¿æ¶µ" },
            { id: 26, name: "æ±¤å¥•è¾°" },
            { id: 27, name: "ç‹é™æ€" },
            { id: 28, name: "ç‹ä¸€æ¶µ" },
            { id: 29, name: "å´ä»•å›" },
            { id: 30, name: "å´æ¬£èˆª" },
            { id: 31, name: "å¤èŠ¸æºª" },
            { id: 32, name: "è‚–è¯ºå¦" },
            { id: 33, name: "è°¢é•°" },
            { id: 34, name: "é‚¢æ¢“ç‘œ" },
            { id: 35, name: "å¾å¥¥éœ" },
            { id: 36, name: "è–›é›¨ç»…" },
            { id: 37, name: "é¢œæ™¶æ™¶" },
            { id: 38, name: "å§šé‡‘è¯­é¦¨" },
            { id: 39, name: "æ®·æ¨±" },
            { id: 40, name: "å°¤èŠ¸ç‘¶" },
            { id: 41, name: "ä¿æ²£èŠ®" },
            { id: 42, name: "è¢æ¢¦å¦‚" },
            { id: 43, name: "å¼ åšæ¶µ" },
            { id: 44, name: "å¼ ç’Ÿé›¯" },
            { id: 45, name: "**" },
            { id: 46, name: "å¼ å‘¨ä¸€" },
            { id: 47, name: "å‘¨ç¿" },
            { id: 48, name: "å‘¨å­å„’" },
            { id: 49, name: "æœ±è´º" },
            { id: 50, name: "é‚¹å…´å®‡" }
        ];

        // åˆå§‹åŒ–è¡¨æ ¼
        function initializeTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td><input type="number" class="form-control last-total-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control last-three-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control chinese-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control math-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control english-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control physics-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control chemistry-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control biology-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control history-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control political-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td><input type="number" class="form-control geography-score" data-id="${student.id}" placeholder="ç¼ºè€ƒç•™ç©º"></td>
                    <td class="current-total-score">-</td>
                    <td class="current-total-rank">-</td>
                    <td class="current-three-score">-</td>
                    <td class="current-three-rank">-</td>
                    <td class="total-rank-change">-</td>
                    <td class="three-rank-change">-</td>
                    <td class="total-credit">-</td>
                    <td class="three-credit">-</td>
                    <td class="single-credit">-</td>
                    <td class="improvement-credit">-</td>
                    <td class="total-added-credit">-</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // ä»Excelå¡«å……è¡¨æ ¼
        function populateTableFromExcel(data) {
            // å‡è®¾Excelç¬¬ä¸€è¡Œä¸ºè¡¨å¤´ï¼Œåç»­è¡Œä¸ºæ•°æ®
            // è¡¨å¤´åº”åŒ…å«ï¼šå­¦å·, å§“å, ä¸Šæ¬¡æ€»æˆç»©, ä¸Šæ¬¡ä¸‰ç§‘æˆç»©, è¯­æ–‡å¾—åˆ†, æ•°å­¦å¾—åˆ†, è‹±è¯­å¾—åˆ†, ç‰©ç†å¾—åˆ†, åŒ–å­¦å¾—åˆ†, ç”Ÿç‰©å¾—åˆ†, å†å²å¾—åˆ†, æ”¿æ²»å¾—åˆ†, åœ°ç†å¾—åˆ†
            if (data.length < 2) {
                alert('Excelæ–‡ä»¶æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ï¼Œè¯·æ£€æŸ¥å¹¶ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æ¨¡æ¿ã€‚');
                return;
            }
            const header = data[0];
            const requiredHeaders = ['å­¦å·', 'å§“å', 'ä¸Šæ¬¡æ€»æˆç»©', 'ä¸Šæ¬¡ä¸‰ç§‘æˆç»©', 'è¯­æ–‡å¾—åˆ†', 'æ•°å­¦å¾—åˆ†', 'è‹±è¯­å¾—åˆ†', 'ç‰©ç†å¾—åˆ†', 'åŒ–å­¦å¾—åˆ†', 'ç”Ÿç‰©å¾—åˆ†', 'å†å²å¾—åˆ†', 'æ”¿æ²»å¾—åˆ†', 'åœ°ç†å¾—åˆ†'];
            for (let i = 0; i < requiredHeaders.length; i++) {
                if (header[i] !== requiredHeaders[i]) {
                    alert(`Excelè¡¨å¤´é”™è¯¯ï¼Œé¢„æœŸç¬¬${i+1}åˆ—ä¸º"${requiredHeaders[i]}"ã€‚`);
                    return;
                }
            }
            // å¡«å……æ•°æ®
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length < 13) continue; // è·³è¿‡ä¸å®Œæ•´çš„è¡Œ
                const id = parseInt(row[0]);
                const lastTotal = row[2] !== undefined ? row[2] : '';
                const lastThree = row[3] !== undefined ? row[3] : '';
                const chinese = row[4] !== undefined ? row[4] : '';
                const math = row[5] !== undefined ? row[5] : '';
                const english = row[6] !== undefined ? row[6] : '';
                const physics = row[7] !== undefined ? row[7] : '';
                const chemistry = row[8] !== undefined ? row[8] : '';
                const biology = row[9] !== undefined ? row[9] : '';
                const history = row[10] !== undefined ? row[10] : '';
                const political = row[11] !== undefined ? row[11] : '';
                const geography = row[12] !== undefined ? row[12] : '';
                // æŸ¥æ‰¾å¯¹åº”çš„è¾“å…¥æ¡†å¹¶å¡«å……
                const lastTotalInput = document.querySelector(`.last-total-score[data-id="${id}"]`);
                const lastThreeInput = document.querySelector(`.last-three-score[data-id="${id}"]`);
                const chineseInput = document.querySelector(`.chinese-score[data-id="${id}"]`);
                const mathInput = document.querySelector(`.math-score[data-id="${id}"]`);
                const englishInput = document.querySelector(`.english-score[data-id="${id}"]`);
                const physicsInput = document.querySelector(`.physics-score[data-id="${id}"]`);
                const chemistryInput = document.querySelector(`.chemistry-score[data-id="${id}"]`);
                const biologyInput = document.querySelector(`.biology-score[data-id="${id}"]`);
                const historyInput = document.querySelector(`.history-score[data-id="${id}"]`);
                const politicalInput = document.querySelector(`.political-score[data-id="${id}"]`);
                const geographyInput = document.querySelector(`.geography-score[data-id="${id}"]`);

                if (lastTotalInput) lastTotalInput.value = lastTotal;
                if (lastThreeInput) lastThreeInput.value = lastThree;
                if (chineseInput) chineseInput.value = chinese;
                if (mathInput) mathInput.value = math;
                if (englishInput) englishInput.value = english;
                if (physicsInput) physicsInput.value = physics;
                if (chemistryInput) chemistryInput.value = chemistry;
                if (biologyInput) biologyInput.value = biology;
                if (historyInput) historyInput.value = history;
                if (politicalInput) politicalInput.value = political;
                if (geographyInput) geographyInput.value = geography;
            }
            alert('æˆç»©å·²æˆåŠŸå¯¼å…¥ï¼ ğŸ˜Š');
        }

        // å¯¼å…¥Excelæ–‡ä»¶
        document.getElementById('import-excel').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    populateTableFromExcel(jsonData);
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        });

        // ä¸‹è½½æ¨¡æ¿
        document.getElementById('download-template').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["å­¦å·", "å§“å", "ä¸Šæ¬¡æ€»æˆç»©", "ä¸Šæ¬¡ä¸‰ç§‘æˆç»©", "è¯­æ–‡å¾—åˆ†", "æ•°å­¦å¾—åˆ†", "è‹±è¯­å¾—åˆ†", "ç‰©ç†å¾—åˆ†", "åŒ–å­¦å¾—åˆ†", "ç”Ÿç‰©å¾—åˆ†", "å†å²å¾—åˆ†", "æ”¿æ²»å¾—åˆ†", "åœ°ç†å¾—åˆ†"]
            ];
            students.forEach(student => {
                ws_data.push([student.id, student.name, "", "", "", "", "", "", "", "", "", "", ""]);
            });
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "æˆç»©æ¨¡æ¿");
            XLSX.writeFile(wb, 'æˆç»©æ¨¡æ¿.xlsx');
        });

        // è®¾ç½®å˜é‡
        const creditLimit = 15; // å›ºå®šæœ€å¤§åŠ åˆ†ä¸º15

        // è®¡ç®—å­¦åˆ†å˜åŒ–
        document.getElementById('calculate-credits').addEventListener('click', () => {

            // è·å–æ‰€æœ‰å­¦ç”Ÿçš„æˆç»©
            const studentData = students.map(student => {
                const lastTotalInput = document.querySelector(`.last-total-score[data-id="${student.id}"]`);
                const lastThreeInput = document.querySelector(`.last-three-score[data-id="${student.id}"]`);
                const chineseInput = document.querySelector(`.chinese-score[data-id="${student.id}"]`);
                const mathInput = document.querySelector(`.math-score[data-id="${student.id}"]`);
                const englishInput = document.querySelector(`.english-score[data-id="${student.id}"]`);
                const physicsInput = document.querySelector(`.physics-score[data-id="${student.id}"]`);
                const chemistryInput = document.querySelector(`.chemistry-score[data-id="${student.id}"]`);
                const biologyInput = document.querySelector(`.biology-score[data-id="${student.id}"]`);
                const historyInput = document.querySelector(`.history-score[data-id="${student.id}"]`);
                const politicalInput = document.querySelector(`.political-score[data-id="${student.id}"]`);
                const geographyInput = document.querySelector(`.geography-score[data-id="${student.id}"]`);
                const lastTotal = lastTotalInput.value === '' ? null : parseFloat(lastTotalInput.value);
                const lastThree = lastThreeInput.value === '' ? null : parseFloat(lastThreeInput.value);
                const chinese = chineseInput.value === '' ? null : parseFloat(chineseInput.value);
                const math = mathInput.value === '' ? null : parseFloat(mathInput.value);
                const english = englishInput.value === '' ? null : parseFloat(englishInput.value);
                const physics = physicsInput.value === '' ? null : parseFloat(physicsInput.value);
                const chemistry = chemistryInput.value === '' ? null : parseFloat(chemistryInput.value);
                const biology = biologyInput.value === '' ? null : parseFloat(biologyInput.value);
                const history = historyInput.value === '' ? null : parseFloat(historyInput.value);
                const political = politicalInput.value === '' ? null : parseFloat(politicalInput.value);
                const geography = geographyInput.value === '' ? null : parseFloat(geographyInput.value);
                const currentTotal = [chinese, math, english, physics, chemistry, biology, history, political, geography].filter(s => s !== null).reduce((a, b) => a + b, 0);
                const currentThree = [chinese, math, english].filter(s => s !== null).reduce((a, b) => a + b, 0);
                return {
                    id: student.id,
                    name: student.name,
                    lastTotal: lastTotal,
                    lastThree: lastThree,
                    chinese: chinese,
                    math: math,
                    english: english,
                    physics: physics,
                    chemistry: chemistry,
                    biology: biology,
                    history: history,
                    political: political,
                    geography: geography,
                    currentTotal: currentTotal,
                    currentThree: currentThree,
                    totalRank: null,
                    threeRank: null,
                    totalRankChange: null,
                    threeRankChange: null,
                    totalCredit: 0,
                    threeCredit: 0,
                    singleCredit: 0,
                    improvementCredit: 0,
                    totalAddedCredit: 0
                };
            });

            // å¤„ç†ç¼ºè€ƒæƒ…å†µ
            const validStudents = studentData.filter(s => s.lastTotal !== null && s.lastThree !== null);

            if (validStudents.length === 0) {
                alert('æ²¡æœ‰æœ‰æ•ˆçš„æˆç»©æ•°æ®è¿›è¡Œè®¡ç®— ğŸ˜•');
                return;
            }

            // è¾“å…¥éªŒè¯
            let invalidInput = false;
            validStudents.forEach(s => {
                if (isNaN(s.currentTotal) || isNaN(s.currentThree)) {
                    invalidInput = true;
                }
            });
            if (invalidInput) {
                alert('å­˜åœ¨æ— æ•ˆçš„æˆç»©è¾“å…¥ï¼Œè¯·æ£€æŸ¥å¹¶é‡æ–°è¾“å…¥ã€‚');
                return;
            }

            // è®¡ç®—æ€»åˆ†æ’å
            const sortedTotal = [...validStudents].sort((a, b) => b.currentTotal - a.currentTotal);
            sortedTotal.forEach((student, index) => {
                student.totalRank = index + 1;
            });

            // è®¡ç®—ä¸‰ç§‘æ€»åˆ†æ’å
            const sortedThree = [...validStudents].sort((a, b) => b.currentThree - a.currentThree);
            sortedThree.forEach((student, index) => {
                student.threeRank = index + 1;
            });

            // è®¡ç®—æ€»åˆ†åæ¬¡å˜åŒ–
            validStudents.forEach(s => {
                if (s.lastTotal !== null) {
                    // æ ¹æ®ä¸Šæ¬¡æ€»æˆç»©è¿›è¡Œæ’åè®¡ç®—
                    const lastTotalSorted = [...validStudents].sort((a, b) => b.lastTotal - a.lastTotal);
                    const lastRank = lastTotalSorted.findIndex(stu => stu.id === s.id) + 1;
                    s.lastTotalRank = lastRank;
                    s.totalRankChange = s.lastTotalRank - s.totalRank;
                } else {
                    s.totalRankChange = null;
                }
            });

            // è®¡ç®—ä¸‰ç§‘åæ¬¡å˜åŒ–
            validStudents.forEach(s => {
                if (s.lastThree !== null) {
                    // æ ¹æ®ä¸Šæ¬¡ä¸‰ç§‘æ€»æˆç»©è¿›è¡Œæ’åè®¡ç®—
                    const lastThreeSorted = [...validStudents].sort((a, b) => b.lastThree - a.lastThree);
                    const lastRank = lastThreeSorted.findIndex(stu => stu.id === s.id) + 1;
                    s.lastThreeRank = lastRank;
                    s.threeRankChange = s.lastThreeRank - s.threeRank;
                } else {
                    s.threeRankChange = null;
                }
            });

            // è®¡ç®—æ€»åˆ†åæ¬¡åŠ åˆ†
            sortedTotal.forEach((s, index) => {
                if (index === 0) {
                    s.totalCredit += 8;
                } else if (index >=1 && index <10) {
                    s.totalCredit += 5;
                }
            });

            // è®¡ç®—ä¸‰ç§‘æ€»åˆ†åæ¬¡åŠ åˆ†
            sortedThree.forEach((s, index) => {
                if (index <10) {
                    s.threeCredit +=3;
                }
            });

            // è®¡ç®—å•ç§‘åŠ åˆ†
            const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology', 'history', 'political', 'geography'];
            subjects.forEach(subject => {
                const sortedSubject = [...validStudents].sort((a, b) => b[subject] - a[subject]);
                sortedSubject.forEach((s, index) => {
                    if (index <5) {
                        s.singleCredit +=2;
                    } else if (index >=5 && index <10) {
                        s.singleCredit +=1;
                    }
                });
            });

            // è®¡ç®—è¿›æ­¥åŠ åˆ†
            validStudents.forEach(s => {
                // æ€»åˆ†è¿›æ­¥
                const totalImprovement = s.totalRankChange;
                if (totalImprovement >=1 && totalImprovement <=10) {
                    s.improvementCredit +=1;
                } else if (totalImprovement >=11 && totalImprovement <=20) {
                    s.improvementCredit +=2;
                } else if (totalImprovement >=21 && totalImprovement <=30) {
                    s.improvementCredit +=3;
                }

                // ä¸‰ç§‘è¿›æ­¥
                const threeImprovement = s.threeRankChange;
                if (threeImprovement >=1 && threeImprovement <=10) {
                    s.improvementCredit +=1;
                } else if (threeImprovement >=11 && threeImprovement <=20) {
                    s.improvementCredit +=2;
                } else if (threeImprovement >=21 && threeImprovement <=30) {
                    s.improvementCredit +=3;
                }

                // ç¡®ä¿åŠ åˆ†ä¸è¶…è¿‡15
                s.totalAddedCredit = s.totalCredit + s.threeCredit + s.singleCredit + s.improvementCredit;
                if (s.totalAddedCredit > creditLimit) {
                    s.totalAddedCredit = creditLimit;
                }
            });

            // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
            validStudents.forEach(s => {
                const row = document.querySelector(`.last-total-score[data-id="${s.id}"]`).closest('tr');
                // å¡«å……æ€»åˆ†
                const currentTotalCell = row.querySelector('.current-total-score');
                currentTotalCell.textContent = s.currentTotal;
                // å¡«å……æ€»åˆ†æ’å
                const currentTotalRankCell = row.querySelector('.current-total-rank');
                currentTotalRankCell.textContent = s.totalRank;
                // å¡«å……ä¸‰ç§‘æ€»åˆ†
                const currentThreeCell = row.querySelector('.current-three-score');
                currentThreeCell.textContent = s.currentThree;
                // å¡«å……ä¸‰ç§‘æ’å
                const currentThreeRankCell = row.querySelector('.current-three-rank');
                currentThreeRankCell.textContent = s.threeRank;
                // å¡«å……æ€»åˆ†åæ¬¡å˜åŒ–
                const totalRankChangeCell = row.querySelector('.total-rank-change');
                if (s.totalRankChange !== null) {
                    const delta = s.totalRankChange;
                    if (delta > 0) {
                        totalRankChangeCell.textContent = `â†‘ ${delta}`;
                        totalRankChangeCell.className = 'total-rank-change rank-up';
                    } else if (delta < 0) {
                        totalRankChangeCell.textContent = `â†“ ${Math.abs(delta)}`;
                        totalRankChangeCell.className = 'total-rank-change rank-down';
                    } else {
                        totalRankChangeCell.textContent = 'â†’ 0';
                        totalRankChangeCell.className = 'total-rank-change rank-neutral';
                    }
                } else {
                    totalRankChangeCell.textContent = '-';
                    totalRankChangeCell.className = 'total-rank-change';
                }

                // å¡«å……ä¸‰ç§‘åæ¬¡å˜åŒ–
                const threeRankChangeCell = row.querySelector('.three-rank-change');
                if (s.threeRankChange !== null) {
                    const delta = s.threeRankChange;
                    if (delta > 0) {
                        threeRankChangeCell.textContent = `â†‘ ${delta}`;
                        threeRankChangeCell.className = 'three-rank-change rank-up';
                    } else if (delta < 0) {
                        threeRankChangeCell.textContent = `â†“ ${Math.abs(delta)}`;
                        threeRankChangeCell.className = 'three-rank-change rank-down';
                    } else {
                        threeRankChangeCell.textContent = 'â†’ 0';
                        threeRankChangeCell.className = 'three-rank-change rank-neutral';
                    }
                } else {
                    threeRankChangeCell.textContent = '-';
                    threeRankChangeCell.className = 'three-rank-change';
                }

                // å¡«å……æ€»åˆ†åæ¬¡åŠ åˆ†
                const totalCreditCell = row.querySelector('.total-credit');
                totalCreditCell.textContent = s.totalCredit;

                // å¡«å……ä¸‰ç§‘åæ¬¡åŠ åˆ†
                const threeCreditCell = row.querySelector('.three-credit');
                threeCreditCell.textContent = s.threeCredit;

                // å¡«å……å•ç§‘åŠ åˆ†
                const singleCreditCell = row.querySelector('.single-credit');
                singleCreditCell.textContent = s.singleCredit;

                // å¡«å……è¿›æ­¥åŠ åˆ†
                const improvementCreditCell = row.querySelector('.improvement-credit');
                improvementCreditCell.textContent = s.improvementCredit;

                // å¡«å……æ€»å…±åŠ åˆ†
                const totalAddedCreditCell = row.querySelector('.total-added-credit');
                totalAddedCreditCell.textContent = s.totalAddedCredit;

                // è®¾ç½®é¢œè‰²
                if (s.totalAddedCredit > 0) {
                    totalAddedCreditCell.classList.add('credit-increase');
                } else {
                    totalAddedCreditCell.classList.remove('credit-increase');
                }
            });

            // ç”Ÿæˆè¿›æ­¥æ’åè¡¨æ ¼
            function generateImprovementTables(validStudents) {
                // æ€»åˆ†è¿›æ­¥æ’å
                const totalImprovementSorted = [...validStudents].sort((a, b) => b.totalRankChange - a.totalRankChange);
                const totalImprovementTableBody = document.querySelector('#total-improvement-table tbody');
                totalImprovementTableBody.innerHTML = '';
                totalImprovementSorted.forEach((s, index) => {
                    if (s.totalRankChange > 0) { // åªæ˜¾ç¤ºè¿›æ­¥çš„å­¦ç”Ÿ
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${s.name}</td>
                            <td>${s.totalRankChange}</td>
                        `;
                        totalImprovementTableBody.appendChild(row);
                    }
                });

                // ä¸‰ç§‘è¿›æ­¥æ’å
                const threeImprovementSorted = [...validStudents].sort((a, b) => (b.threeRankChange || 0) - (a.threeRankChange || 0));
                const threeImprovementTableBody = document.querySelector('#three-improvement-table tbody');
                threeImprovementTableBody.innerHTML = '';
                threeImprovementSorted.forEach((s, index) => {
                    if (s.threeRankChange > 0) { // åªæ˜¾ç¤ºè¿›æ­¥çš„å­¦ç”Ÿ
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${s.name}</td>
                            <td>${s.threeRankChange}</td>
                        `;
                        threeImprovementTableBody.appendChild(row);
                    }
                });
            }

            // ç”Ÿæˆå­¦åˆ†å˜åŒ–åˆ†å¸ƒå›¾
            let creditChart; // å…¨å±€å˜é‡
            function generateCreditChart(validStudents) {
                const ctx = document.getElementById('creditChart').getContext('2d');
                const creditChanges = validStudents.map(s => s.totalAddedCredit);
                const creditLabels = [...new Set(creditChanges)].sort((a, b) => b - a);
                const creditCounts = creditLabels.map(label => creditChanges.filter(c => c === label).length);
                // å¦‚æœå›¾è¡¨å·²ç»å­˜åœ¨ï¼ŒæŠŠå®ƒé”€æ¯
                if (creditChart) {
                    creditChart.destroy();
                }
                creditChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: creditLabels.map(label => `+${label}`),
                        datasets: [{
                            label: 'å­¦åˆ†å¢åŠ äººæ•°',
                            data: creditCounts,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'äººæ•°'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'å­¦åˆ†å¢åŠ '
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: false,
                                text: 'å­¦åˆ†å¢åŠ åˆ†å¸ƒå›¾'
                            }
                        }
                    }
                });
            }

            // å¯¼å‡ºç»“æœä¸ºExcel
            document.getElementById('export-results').addEventListener('click', () => {
                const table = document.getElementById('scores-table');
                const headers = [];
                const rows = [];
                // è·å–è¡¨å¤´
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(header => {
                    headers.push(header.textContent.trim());
                });
                // è·å–è¡¨æ ¼æ•°æ®
                const tableBody = table.querySelectorAll('tbody tr');
                tableBody.forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach((cell, index) => {
                        if (index <= 12) {
                            // å­¦å·åˆ°åœ°ç†å¾—åˆ†ï¼Œè·å–è¾“å…¥å­—æ®µçš„å€¼
                            const input = cell.querySelector('input');
                            rowData.push(input ? input.value : '');
                        } else {
                            // å…¶ä»–åˆ—ï¼Œè·å–æ–‡æœ¬å†…å®¹
                            rowData.push(cell.textContent.trim());
                        }
                    });
                    rows.push(rowData);
                });
                // ç»„åˆè¡¨å¤´å’Œè¡¨æ ¼æ•°æ®
                const ws_data = [headers, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ä¸»è¡¨");
                
                // æ·»åŠ æ€»åˆ†è¿›æ­¥æ’å
                const totalImprovementHeaders = ["æ’å", "å§“å", "è¿›æ­¥åæ¬¡"];
                const totalImprovementRows = [];
                const totalImprovementTable = document.getElementById('total-improvement-table');
                const totalBody = totalImprovementTable.querySelector('tbody').querySelectorAll('tr');
                totalBody.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push(cell.textContent.trim());
                    });
                    totalImprovementRows.push(rowData);
                });
                if (totalImprovementRows.length > 0) {
                    const ws_total = XLSX.utils.aoa_to_sheet([totalImprovementHeaders, ...totalImprovementRows]);
                    XLSX.utils.book_append_sheet(wb, ws_total, "æ€»åˆ†è¿›æ­¥æ’å");
                }

                // æ·»åŠ ä¸‰ç§‘è¿›æ­¥æ’å
                const threeImprovementHeaders = ["æ’å", "å§“å", "è¿›æ­¥åæ¬¡"];
                const threeImprovementRows = [];
                const threeImprovementTable = document.getElementById('three-improvement-table');
                const threeBody = threeImprovementTable.querySelector('tbody').querySelectorAll('tr');
                threeBody.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push(cell.textContent.trim());
                    });
                    threeImprovementRows.push(rowData);
                });
                if (threeImprovementRows.length > 0) {
                    const ws_three = XLSX.utils.aoa_to_sheet([threeImprovementHeaders, ...threeImprovementRows]);
                    XLSX.utils.book_append_sheet(wb, ws_three, "ä¸‰ç§‘è¿›æ­¥æ’å");
                }

                XLSX.writeFile(wb, 'å­¦åˆ†è®¡ç®—ç»“æœ.xlsx');
            });

            // åˆå§‹åŒ–è¡¨æ ¼
            document.addEventListener('DOMContentLoaded', initializeTable);

            // è®¡ç®—å­¦åˆ†å¹¶ç”Ÿæˆæ’åè¡¨æ ¼åŠå›¾è¡¨
            document.getElementById('calculate-credits').addEventListener('click', () => {

                // è·å–æ‰€æœ‰å­¦ç”Ÿçš„æˆç»©
                const studentData = students.map(student => {
                    const lastTotalInput = document.querySelector(`.last-total-score[data-id="${student.id}"]`);
                    const lastThreeInput = document.querySelector(`.last-three-score[data-id="${student.id}"]`);
                    const chineseInput = document.querySelector(`.chinese-score[data-id="${student.id}"]`);
                    const mathInput = document.querySelector(`.math-score[data-id="${student.id}"]`);
                    const englishInput = document.querySelector(`.english-score[data-id="${student.id}"]`);
                    const physicsInput = document.querySelector(`.physics-score[data-id="${student.id}"]`);
                    const chemistryInput = document.querySelector(`.chemistry-score[data-id="${student.id}"]`);
                    const biologyInput = document.querySelector(`.biology-score[data-id="${student.id}"]`);
                    const historyInput = document.querySelector(`.history-score[data-id="${student.id}"]`);
                    const politicalInput = document.querySelector(`.political-score[data-id="${student.id}"]`);
                    const geographyInput = document.querySelector(`.geography-score[data-id="${student.id}"]`);
                    const lastTotal = lastTotalInput.value === '' ? null : parseFloat(lastTotalInput.value);
                    const lastThree = lastThreeInput.value === '' ? null : parseFloat(lastThreeInput.value);
                    const chinese = chineseInput.value === '' ? null : parseFloat(chineseInput.value);
                    const math = mathInput.value === '' ? null : parseFloat(mathInput.value);
                    const english = englishInput.value === '' ? null : parseFloat(englishInput.value);
                    const physics = physicsInput.value === '' ? null : parseFloat(physicsInput.value);
                    const chemistry = chemistryInput.value === '' ? null : parseFloat(chemistryInput.value);
                    const biology = biologyInput.value === '' ? null : parseFloat(biologyInput.value);
                    const history = historyInput.value === '' ? null : parseFloat(historyInput.value);
                    const political = politicalInput.value === '' ? null : parseFloat(politicalInput.value);
                    const geography = geographyInput.value === '' ? null : parseFloat(geographyInput.value);
                    const currentTotal = [chinese, math, english, physics, chemistry, biology, history, political, geography].filter(s => s !== null).reduce((a, b) => a + b, 0);
                    const currentThree = [chinese, math, english].filter(s => s !== null).reduce((a, b) => a + b, 0);
                    return {
                        id: student.id,
                        name: student.name,
                        lastTotal: lastTotal,
                        lastThree: lastThree,
                        chinese: chinese,
                        math: math,
                        english: english,
                        physics: physics,
                        chemistry: chemistry,
                        biology: biology,
                        history: history,
                        political: political,
                        geography: geography,
                        currentTotal: currentTotal,
                        currentThree: currentThree,
                        totalRank: null,
                        threeRank: null,
                        totalRankChange: null,
                        threeRankChange: null,
                        totalCredit: 0,
                        threeCredit: 0,
                        singleCredit: 0,
                        improvementCredit: 0,
                        totalAddedCredit: 0
                    };
                });

                // å¤„ç†ç¼ºè€ƒæƒ…å†µ
                const validStudents = studentData.filter(s => s.lastTotal !== null && s.lastThree !== null);

                if (validStudents.length === 0) {
                    alert('æ²¡æœ‰æœ‰æ•ˆçš„æˆç»©æ•°æ®è¿›è¡Œè®¡ç®— ğŸ˜•');
                    return;
                }

                // è¾“å…¥éªŒè¯
                let invalidInput = false;
                validStudents.forEach(s => {
                    if (isNaN(s.currentTotal) || isNaN(s.currentThree)) {
                        invalidInput = true;
                    }
                });
                if (invalidInput) {
                    alert('å­˜åœ¨æ— æ•ˆçš„æˆç»©è¾“å…¥ï¼Œè¯·æ£€æŸ¥å¹¶é‡æ–°è¾“å…¥ã€‚');
                    return;
                }

                // è®¡ç®—æ€»åˆ†æ’å
                const sortedTotal = [...validStudents].sort((a, b) => b.currentTotal - a.currentTotal);
                sortedTotal.forEach((student, index) => {
                    student.totalRank = index + 1;
                });

                // è®¡ç®—ä¸‰ç§‘æ€»åˆ†æ’å
                const sortedThree = [...validStudents].sort((a, b) => b.currentThree - a.currentThree);
                sortedThree.forEach((student, index) => {
                    student.threeRank = index + 1;
                });

                // è®¡ç®—æ€»åˆ†åæ¬¡å˜åŒ–
                validStudents.forEach(s => {
                    if (s.lastTotal !== null) {
                        // æ ¹æ®ä¸Šæ¬¡æ€»æˆç»©è¿›è¡Œæ’åè®¡ç®—
                        const lastTotalSorted = [...validStudents].sort((a, b) => b.lastTotal - a.lastTotal);
                        const lastRank = lastTotalSorted.findIndex(stu => stu.id === s.id) + 1;
                        s.lastTotalRank = lastRank;
                        s.totalRankChange = s.lastTotalRank - s.totalRank;
                    } else {
                        s.totalRankChange = null;
                    }
                });

                // è®¡ç®—ä¸‰ç§‘åæ¬¡å˜åŒ–
                validStudents.forEach(s => {
                    if (s.lastThree !== null) {
                        // æ ¹æ®ä¸Šæ¬¡ä¸‰ç§‘æ€»æˆç»©è¿›è¡Œæ’åè®¡ç®—
                        const lastThreeSorted = [...validStudents].sort((a, b) => b.lastThree - a.lastThree);
                        const lastRank = lastThreeSorted.findIndex(stu => stu.id === s.id) + 1;
                        s.lastThreeRank = lastRank;
                        s.threeRankChange = s.lastThreeRank - s.threeRank;
                    } else {
                        s.threeRankChange = null;
                    }
                });

                // è®¡ç®—æ€»åˆ†åæ¬¡åŠ åˆ†
                sortedTotal.forEach((s, index) => {
                    if (index === 0) {
                        s.totalCredit += 8;
                    } else if (index >=1 && index <10) {
                        s.totalCredit += 5;
                    }
                });

                // è®¡ç®—ä¸‰ç§‘æ€»åˆ†åæ¬¡åŠ åˆ†
                sortedThree.forEach((s, index) => {
                    if (index <10) {
                        s.threeCredit +=3;
                    }
                });

                // è®¡ç®—å•ç§‘åŠ åˆ†
                const subjects = ['chinese', 'math', 'english', 'physics', 'chemistry', 'biology', 'history', 'political', 'geography'];
                subjects.forEach(subject => {
                    const sortedSubject = [...validStudents].sort((a, b) => b[subject] - a[subject]);
                    sortedSubject.forEach((s, index) => {
                        if (index <5) {
                            s.singleCredit +=2;
                        } else if (index >=5 && index <10) {
                            s.singleCredit +=1;
                        }
                    });
                });

                // è®¡ç®—è¿›æ­¥åŠ åˆ†
                validStudents.forEach(s => {
                    // æ€»åˆ†è¿›æ­¥
                    const totalImprovement = s.totalRankChange;
                    if (totalImprovement >=1 && totalImprovement <=10) {
                        s.improvementCredit +=1;
                    } else if (totalImprovement >=11 && totalImprovement <=20) {
                        s.improvementCredit +=2;
                    } else if (totalImprovement >=21 && totalImprovement <=30) {
                        s.improvementCredit +=3;
                    }

                    // ä¸‰ç§‘è¿›æ­¥
                    const threeImprovement = s.threeRankChange;
                    if (threeImprovement >=1 && threeImprovement <=10) {
                        s.improvementCredit +=1;
                    } else if (threeImprovement >=11 && threeImprovement <=20) {
                        s.improvementCredit +=2;
                    } else if (threeImprovement >=21 && threeImprovement <=30) {
                        s.improvementCredit +=3;
                    }

                    // ç¡®ä¿åŠ åˆ†ä¸è¶…è¿‡15
                    s.totalAddedCredit = s.totalCredit + s.threeCredit + s.singleCredit + s.improvementCredit;
                    if (s.totalAddedCredit > creditLimit) {
                        s.totalAddedCredit = creditLimit;
                    }
                });

                // æ›´æ–°è¡¨æ ¼æ˜¾ç¤º
                validStudents.forEach(s => {
                    const row = document.querySelector(`.last-total-score[data-id="${s.id}"]`).closest('tr');
                    // å¡«å……æ€»åˆ†
                    const currentTotalCell = row.querySelector('.current-total-score');
                    currentTotalCell.textContent = s.currentTotal;
                    // å¡«å……æ€»åˆ†æ’å
                    const currentTotalRankCell = row.querySelector('.current-total-rank');
                    currentTotalRankCell.textContent = s.totalRank;
                    // å¡«å……ä¸‰ç§‘æ€»åˆ†
                    const currentThreeCell = row.querySelector('.current-three-score');
                    currentThreeCell.textContent = s.currentThree;
                    // å¡«å……ä¸‰ç§‘æ’å
                    const currentThreeRankCell = row.querySelector('.current-three-rank');
                    currentThreeRankCell.textContent = s.threeRank;
                    // å¡«å……æ€»åˆ†åæ¬¡å˜åŒ–
                    const totalRankChangeCell = row.querySelector('.total-rank-change');
                    if (s.totalRankChange !== null) {
                        const delta = s.totalRankChange;
                        if (delta > 0) {
                            totalRankChangeCell.textContent = `â†‘ ${delta}`;
                            totalRankChangeCell.className = 'total-rank-change rank-up';
                        } else if (delta < 0) {
                            totalRankChangeCell.textContent = `â†“ ${Math.abs(delta)}`;
                            totalRankChangeCell.className = 'total-rank-change rank-down';
                        } else {
                            totalRankChangeCell.textContent = 'â†’ 0';
                            totalRankChangeCell.className = 'total-rank-change rank-neutral';
                        }
                    } else {
                        totalRankChangeCell.textContent = '-';
                        totalRankChangeCell.className = 'total-rank-change';
                    }

                    // å¡«å……ä¸‰ç§‘åæ¬¡å˜åŒ–
                    const threeRankChangeCell = row.querySelector('.three-rank-change');
                    if (s.threeRankChange !== null) {
                        const delta = s.threeRankChange;
                        if (delta > 0) {
                            threeRankChangeCell.textContent = `â†‘ ${delta}`;
                            threeRankChangeCell.className = 'three-rank-change rank-up';
                        } else if (delta < 0) {
                            threeRankChangeCell.textContent = `â†“ ${Math.abs(delta)}`;
                            threeRankChangeCell.className = 'three-rank-change rank-down';
                        } else {
                            threeRankChangeCell.textContent = 'â†’ 0';
                            threeRankChangeCell.className = 'three-rank-change rank-neutral';
                        }
                    } else {
                        threeRankChangeCell.textContent = '-';
                        threeRankChangeCell.className = 'three-rank-change';
                    }

                    // å¡«å……æ€»åˆ†åæ¬¡åŠ åˆ†
                    const totalCreditCell = row.querySelector('.total-credit');
                    totalCreditCell.textContent = s.totalCredit;

                    // å¡«å……ä¸‰ç§‘åæ¬¡åŠ åˆ†
                    const threeCreditCell = row.querySelector('.three-credit');
                    threeCreditCell.textContent = s.threeCredit;

                    // å¡«å……å•ç§‘åŠ åˆ†
                    const singleCreditCell = row.querySelector('.single-credit');
                    singleCreditCell.textContent = s.singleCredit;

                    // å¡«å……è¿›æ­¥åŠ åˆ†
                    const improvementCreditCell = row.querySelector('.improvement-credit');
                    improvementCreditCell.textContent = s.improvementCredit;

                    // å¡«å……æ€»å…±åŠ åˆ†
                    const totalAddedCreditCell = row.querySelector('.total-added-credit');
                    totalAddedCreditCell.textContent = s.totalAddedCredit;

                    // è®¾ç½®é¢œè‰²
                    if (s.totalAddedCredit > 0) {
                        totalAddedCreditCell.classList.add('credit-increase');
                    } else {
                        totalAddedCreditCell.classList.remove('credit-increase');
                    }
                });

                // ç”Ÿæˆè¿›æ­¥æ’åè¡¨æ ¼
                generateImprovementTables(validStudents);

                // ç”Ÿæˆå­¦åˆ†å˜åŒ–åˆ†å¸ƒå›¾
                generateCreditChart(validStudents);
                alert('å­¦åˆ†è®¡ç®—å®Œæˆã€‚ ğŸ‰');
            });

            // ç”Ÿæˆè¿›æ­¥æ’åè¡¨æ ¼
            function generateImprovementTables(validStudents) {
                // æ€»åˆ†è¿›æ­¥æ’å
                const totalImprovementSorted = [...validStudents].sort((a, b) => b.totalRankChange - a.totalRankChange);
                const totalImprovementTableBody = document.querySelector('#total-improvement-table tbody');
                totalImprovementTableBody.innerHTML = '';
                totalImprovementSorted.forEach((s, index) => {
                    if (s.totalRankChange > 0) { // åªæ˜¾ç¤ºè¿›æ­¥çš„å­¦ç”Ÿ
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${s.name}</td>
                            <td>${s.totalRankChange}</td>
                        `;
                        totalImprovementTableBody.appendChild(row);
                    }
                });

                // ä¸‰ç§‘è¿›æ­¥æ’å
                const threeImprovementSorted = [...validStudents].sort((a, b) => (b.threeRankChange || 0) - (a.threeRankChange || 0));
                const threeImprovementTableBody = document.querySelector('#three-improvement-table tbody');
                threeImprovementTableBody.innerHTML = '';
                threeImprovementSorted.forEach((s, index) => {
                    if (s.threeRankChange > 0) { // åªæ˜¾ç¤ºè¿›æ­¥çš„å­¦ç”Ÿ
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${s.name}</td>
                            <td>${s.threeRankChange}</td>
                        `;
                        threeImprovementTableBody.appendChild(row);
                    }
                });
            }

            // å¯¼å‡ºç»“æœä¸ºExcel
            document.getElementById('export-results').addEventListener('click', () => {
                const table = document.getElementById('scores-table');
                const headers = [];
                const rows = [];
                // è·å–è¡¨å¤´
                const headerCells = table.querySelectorAll('thead th');
                headerCells.forEach(header => {
                    headers.push(header.textContent.trim());
                });
                // è·å–è¡¨æ ¼æ•°æ®
                const tableBody = table.querySelectorAll('tbody tr');
                tableBody.forEach(row => {
                    const rowData = [];
                    row.querySelectorAll('td').forEach((cell, index) => {
                        if (index <= 12) {
                            // å­¦å·åˆ°åœ°ç†å¾—åˆ†ï¼Œè·å–è¾“å…¥å­—æ®µçš„å€¼
                            const input = cell.querySelector('input');
                            rowData.push(input ? input.value : '');
                        } else {
                            // å…¶ä»–åˆ—ï¼Œè·å–æ–‡æœ¬å†…å®¹
                            rowData.push(cell.textContent.trim());
                        }
                    });
                    rows.push(rowData);
                });
                // ç»„åˆè¡¨å¤´å’Œè¡¨æ ¼æ•°æ®
                const ws_data = [headers, ...rows];
                const ws = XLSX.utils.aoa_to_sheet(ws_data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "ä¸»è¡¨");
                
                // æ·»åŠ æ€»åˆ†è¿›æ­¥æ’å
                const totalImprovementHeaders = ["æ’å", "å§“å", "è¿›æ­¥åæ¬¡"];
                const totalImprovementRows = [];
                const totalImprovementTable = document.getElementById('total-improvement-table');
                const totalBody = totalImprovementTable.querySelector('tbody').querySelectorAll('tr');
                totalBody.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push(cell.textContent.trim());
                    });
                    totalImprovementRows.push(rowData);
                });
                if (totalImprovementRows.length > 0) {
                    const ws_total = XLSX.utils.aoa_to_sheet([totalImprovementHeaders, ...totalImprovementRows]);
                    XLSX.utils.book_append_sheet(wb, ws_total, "æ€»åˆ†è¿›æ­¥æ’å");
                }

                // æ·»åŠ ä¸‰ç§‘è¿›æ­¥æ’å
                const threeImprovementHeaders = ["æ’å", "å§“å", "è¿›æ­¥åæ¬¡"];
                const threeImprovementRows = [];
                const threeImprovementTable = document.getElementById('three-improvement-table');
                const threeBody = threeImprovementTable.querySelector('tbody').querySelectorAll('tr');
                threeBody.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const rowData = [];
                    cells.forEach(cell => {
                        rowData.push(cell.textContent.trim());
                    });
                    threeImprovementRows.push(rowData);
                });
                if (threeImprovementRows.length > 0) {
                    const ws_three = XLSX.utils.aoa_to_sheet([threeImprovementHeaders, ...threeImprovementRows]);
                    XLSX.utils.book_append_sheet(wb, ws_three, "ä¸‰ç§‘è¿›æ­¥æ’å");
                }

                XLSX.writeFile(wb, 'å­¦åˆ†è®¡ç®—ç»“æœ.xlsx');
            });

            // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆå­¦åˆ†å˜åŒ–åˆ†å¸ƒå›¾
            let creditChart; // å…¨å±€å˜é‡
            function generateCreditChart(validStudents) {
                const ctx = document.getElementById('creditChart').getContext('2d');
                const creditChanges = validStudents.map(s => s.totalAddedCredit);
                const creditLabels = [...new Set(creditChanges)].sort((a, b) => b - a);
                const creditCounts = creditLabels.map(label => creditChanges.filter(c => c === label).length);
                // å¦‚æœå›¾è¡¨å·²ç»å­˜åœ¨ï¼ŒæŠŠå®ƒé”€æ¯
                if (creditChart) {
                    creditChart.destroy();
                }
                creditChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: creditLabels.map(label => `+${label}`),
                        datasets: [{
                            label: 'å­¦åˆ†å¢åŠ äººæ•°',
                            data: creditCounts,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'äººæ•°'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'å­¦åˆ†å¢åŠ '
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            title: {
                                display: false,
                                text: 'å­¦åˆ†å¢åŠ åˆ†å¸ƒå›¾'
                            }
                        }
                    }
                });
            }

        </script>

</body>
</html>
