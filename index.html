<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高一1班学分计算系统</title>

    <!-- 为什么来看源代码？怕我搞后门？不信我绝交了呜呜呜呜呜呜呜呜呜呜呜呜哼-->

    <style>
        body {
            padding: 20px;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }

        .credit-increase {
            color: green;
            font-weight: bold;
        }

        .credit-decrease {
            color: red;
            font-weight: bold;
        }

        .table-responsive {
            max-height: 600px;
            overflow-y: auto;
        }

        .rank-up {
            color: green;
        }

        .rank-down {
            color: red;
        }

        .rank-neutral {
            color: gray;
        }

        /* 图表容器样式 */
        .chart-container {
            margin-top: 40px;
        }

        /* 预留空间，减少布局偏移 */
        img {
            width: 100%;
            height: auto;
            display: block;
        }

        /* 学生成绩表格样式 */
        table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
        }

        th, td {
            text-align: center;
            padding: 8px;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }

        th {
            background-color: #f1f1f1;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        /* 按钮样式 */
        .btn {
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .btn:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            th, td {
                font-size: 10px;
                padding: 4px;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5rem;
            }
            .table-responsive {
                max-height: 400px;
            }
            th, td {
                font-size: 8px;
                padding: 2px;
            }
        }

        /* 模态框图片 */
        .modal-body img {
            width: 100%;
            height: auto;
        }

        /* 更新日志 */
        #update-log .list-group-item {
            font-size: 0.95rem;
        }

        .alert-info {
            font-size: 0.95rem;
        }

        /* 链接按钮样式 */
        .btn-outline-primary img {
            vertical-align: middle;
        }
    </style>

    <!-- 延迟加载非关键CSS：Font Awesome 和 Bootstrap 5.3.0 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"></noscript>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"></noscript>

    <!-- 延迟加载 JavaScript 库，确保顺序 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" defer></script>
</head>
<body>

    <div class="container">
        <h1 class="mb-4 text-center">高一1班学分计算系统(V2.1.0) BY ZZY</h1>

        <!-- 数据导入导出 -->
        <div class="mb-4 d-flex justify-content-between">
            <div>
                <button class="btn btn-success me-2" id="import-excel"><i class="fa fa-file-import"></i> 从Excel导入成绩</button>
                <button class="btn btn-info" id="export-results"><i class="fa fa-file-export"></i> 导出计算结果为Excel</button>
            </div>
            <div>
                <button class="btn btn-secondary" id="download-template"><i class="fa fa-download"></i> 下载Excel模板</button>
                <!-- 解释按钮 -->
                <button class="btn btn-outline-info ms-2" type="button" data-bs-toggle="collapse" data-bs-target="#algorithmExplanation" aria-expanded="false" aria-controls="algorithmExplanation">
                    <i class="fa fa-info-circle"></i> 学分算法说明
                </button>
            </div>
        </div>

        <div class="collapse mb-4" id="algorithmExplanation">
            <div class="card card-body">
                <h5>学分计算算法说明</h5>
                <p>本系统根据以下规则计算学分增减：</p>
                <ul>
                    <li>总分第一名，加8分</li>
                    <li>总分2-10名，加5分</li>
                    <li>三科（语文、数学、英语）总分前十，加3分</li>
                    <li>单科前五，加2分</li>
                    <li>单科6-10名，加1分</li>
                    <li>总分比上一次考试进步1-10名，加1分</li>
                    <li>总分比上一次考试进步11-20名，加2分</li>
                    <li>总分比上一次考试进步21-30名，加3分</li>
                    <li>三科比上一次考试进步1-10名，加1分</li>
                    <li>三科比上一次考试进步11-20名，加2分</li>
                    <li>三科比上一次考试进步21-30名，加3分</li>
                    <li>每个人加分不得超过15分</li>
                </ul>
                <p>系统会根据上述规则自动计算每位学生的学分变化，并提供详细的加分原因。</p>

                <!-- 插入手写算法说明珍贵文献，并使用 Bootstrap 网格系统 -->
                <div class="row text-center">
                    <div class="col-4">
                        <img src="1.webp" alt="算法图示1" class="img-fluid img-thumbnail" data-bs-toggle="modal" data-bs-target="#imageModal1">
                    </div>
                    <div class="col-4">
                        <img src="2.webp" alt="算法图示2" class="img-fluid img-thumbnail" data-bs-toggle="modal" data-bs-target="#imageModal2">
                    </div>
                    <div class="col-4">
                        <img src="3.webp" alt="算法图示3" class="img-fluid img-thumbnail" data-bs-toggle="modal" data-bs-target="#imageModal3"> 
                    </div>
                </div>
                <div class="modal fade" id="imageModal1" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="imageModalLabel1">算法图示1</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="1.webp" alt="算法图示1" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="imageModal2" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel2" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="imageModalLabel2">算法图示2</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="2.webp" alt="算法图示2" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="imageModal3" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel3" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="imageModalLabel3">算法图示3</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <img src="3.webp" alt="算法图示3" class="img-fluid">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 成绩输入表格 -->
        <div class="table-responsive mb-4">
            <strong style="color:red">名单如果没加载出来，试着多刷新几次或清除浏览器缓存</strong>
            <table class="table table-bordered table-hover" id="scores-table">
                <thead class="table-light sticky-top">
                    <tr>
                        <th rowspan="2">学号</th>
                        <th rowspan="2">姓名</th>
                        <th colspan="2">上次成绩</th>
                        <th colspan="9">本次成绩</th>
                        <th colspan="2">当前排名</th>
                        <th rowspan="2">总分排名变化</th>
                        <th rowspan="2">三科排名变化</th>
                        <th rowspan="2">学分变化</th>
                    </tr>
                    <tr>
                        <th>总分</th>
                        <th>三科总分</th>
                        <th>语文</th>
                        <th>数学</th>
                        <th>英语</th>
                        <th>物理</th>
                        <th>化学</th>
                        <th>生物</th>
                        <th>历史</th>
                        <th>政治</th>
                        <th>地理</th>
                        <th>总分</th>
                        <th>三科总分</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- 动态生成表格行 -->
                </tbody>
            </table>
        </div>

        <!-- 计算按钮 -->
        <div class="mb-4 text-center">
            <button class="btn btn-primary btn-lg" id="calculate-credits"><i class="fa fa-calculator"></i> 计算学分</button>
        </div>

        <!-- 学分结果展示提示 -->
        <div id="results-section">
            <!-- 结果将在此处显示 -->
        </div>

        <!-- 图表容器 -->
        <div class="chart-container">
            <h3 class="text-center">学分变化分布图（会在计算出学分后显示）</h3>
            <canvas id="creditChart"></canvas>
        </div>
    </div>
    <!-- 更新日志 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5>更新日志</h5>
        </div>
        <div class="card-body">
            <ul class="list-group list-group-flush" id="update-log">
                <li class="list-group-item">
                    <strong>2024-10-19 Beta</strong>: 建立学分计算模型，程序demo
                </li>
                <li class="list-group-item">
                    <strong>2024-10-21 V1.0.0</strong>: 正式版发布：1.添加数据隐私声明和源代码链接，优化界面；2.默认更合理的权重；3.优化算法；4.修复学分限制在两分的bug，原因分析：demo中用于测试的数值2在后期修改中只改了html中的数值，js中的数值没变，导致计算时最大学分限制仍为2；5.优化网页加载速度，修改内容包括但不限于使用更轻量级的webp格式， 延迟加载js，Lazy loading；6.开放源代码
                </li>
                <li class="list-group-item">
                    <strong>2024-10-26 V1.2.0</strong>: 1.ui升级 2.延迟加载一些不是立即需要的库，加快网页绘制速度 3.由GitHub+Vercel的托管策略改为阿里云oss（对象存储）作为服务器，网页打开速度大幅度提升
                </li>
                 <li class="list-group-item">
                    <strong>2024-10-27 V1.2.1</strong>:修复无法正常导出excel的bug
                </li>
                <li class="list-group-item">
                    <strong>2024-10-28 V1.2.4</strong>:1.优化代码排版;2.解决导出的excel中无成绩的问题;3.解决算法图示点开后没法关闭的问题
                </li>
                <li class="list-group-item">
                    <strong>2024-11-2 V1.3.0</strong>:1.优化操作逻辑，更改设置后立即生效而不需要再点击应用设置按钮；2.解释权重页；3.修复了上次缺考而此次不缺考但排名无法计算的问题
                </li>
                <li class="list-group-item">
                    <strong>2024-11-3 V1.3.5</strong>:1.修复v1.3.0更新导致的权重加载陷入死循环而拖慢网页加载速度的问题
                </li>
                <li class="list-group-item">
                    <strong>2024-11-6 V1.4.0</strong>:为方便考场显示时间，新写了个时钟的网页，链接在页面最后开源处
                </li>
               </ul>
        </div>
    </div>

    <div class="alert alert-info mt-4" role="alert">
        <p>本系统保证公平公正，所有计算均在本地进行，不会以任何形式收集或上传任何数据（包括但不限于成绩和排名）网页一旦刷新或关闭，数据立即销毁。还不信？可等待网页加载完成后，断网输入成绩计算。项目已开源，欢迎检查源代码、提出issue，参与开发。</p>
        <a href="https://github.com/zhangMonday/gaoyi1credit" target="_blank" class="btn btn-outline-primary mt-2">
            <img src="github.svg" alt="GitHub" style="width: 16px; height: 16px; margin-right: 4px;">
            开源地址
        </a>
        <a href="https://credit1.zhangmonday.top/clock.html" target="_blank" class="btn btn-outline-primary mt-2">
            <img src="https://credit1.zhangmonday.top/icons/icon-192.png" alt="clock" style="width: 16px; height: 16px; margin-right: 4px;">
            考场时间
        </a>
    </div>

    <!-- 主脚本 -->
    <script defer>
        /* 
            　　 　▃▆█▇▄▖
           　　 　▟◤▖　　　◥█▎
          　　　◢◤　 ▐　　　　▐▉
          　▗◤　　　▂　▗▖　　▕█▎
          　◤　▗▅▖◥▄　▀◣　　█▊
          ▐　▕▎◥▖◣◤　　　　◢██
          █◣　◥▅█▀　　　　▐██◤
          ▐█▙▂　　　 ◢██◤
          　◥██▣　　　　◢▄◤
                 ▀██▅▇▀
        */

        // 本班名单
        const students = [
            { id: 1, name: "蔡克一" },
            { id: 2, name: "陈爱嘉" },
            { id: 3, name: "陈庆隆" },
            { id: 4, name: "程博涵" },
            { id: 5, name: "丁陈浩" },
            { id: 6, name: "范饶" },
            { id: 7, name: "冯谨远" },
            { id: 8, name: "付世鑫" },
            { id: 9, name: "郭陈凯" },
            { id: 10, name: "胡莘桐" },
            { id: 11, name: "宦晓诚" },
            { id: 12, name: "纪裕韬" },
            { id: 13, name: "蓝天宇" },
            { id: 14, name: "李佳妮" },
            { id: 15, name: "李宇涵" },
            { id: 16, name: "刘宸玮" },
            { id: 17, name: "卢钰涛" },
            { id: 18, name: "陆一涵" },
            { id: 19, name: "毛语馨" },
            { id: 20, name: "穆子浩" },
            { id: 21, name: "潘莣萧" },
            { id: 22, name: "戚天娇" },
            { id: 23, name: "钱湘钰" },
            { id: 24, name: "沈睿涵" },
            { id: 26, name: "汤奕辰" },
            { id: 27, name: "王静思" },
            { id: 28, name: "王一涵" },
            { id: 29, name: "吴仕君" },
            { id: 30, name: "吴欣航" },
            { id: 31, name: "夏芸溪" },
            { id: 32, name: "肖诺妍" },
            { id: 33, name: "谢镰" },
            { id: 34, name: "邢梓瑜" },
            { id: 35, name: "徐奥霁" },
            { id: 36, name: "薛雨绅" },
            { id: 37, name: "颜晶晶" },
            { id: 38, name: "姚金语馨" },
            { id: 39, name: "殷樱" },
            { id: 40, name: "尤芸瑶" },
            { id: 41, name: "俞沣芮" },
            { id: 42, name: "袁梦如" },
            { id: 43, name: "张厚涵" },
            { id: 44, name: "张璟雯" },
            { id: 45, name: "**" },
            { id: 46, name: "张周一" },
            { id: 47, name: "周灿" },
            { id: 48, name: "周孝儒" },
            { id: 49, name: "朱贺" },
            { id: 50, name: "邹兴宇" }
        ];

        // 初始化表格
        function initializeTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td><input type="number" class="form-control last-total-score" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control last-three-total" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-chinese" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-math" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-english" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-physics" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-chemistry" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-biology" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-history" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-politics" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td><input type="number" class="form-control current-geography" data-id="${student.id}" placeholder="缺考留空"></td>
                    <td class="current-total-score">-</td>
                    <td class="current-three-total">-</td>
                    <td class="current-rank">-</td>
                    <td class="current-three-rank">-</td>
                    <td class="rank-change-total">-</td>
                    <td class="rank-change-three">-</td>
                    <td class="credit-change">-</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 导入Excel文件
        document.getElementById('import-excel').addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.xlsx, .xls';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    populateTableFromExcel(jsonData);
                };
                reader.readAsArrayBuffer(file);
            };
            input.click();
        });

        // 从Excel填充表格
        function populateTableFromExcel(data) {
            // 假设Excel第一行为表头，后续行为数据
            // 表头应包含：学号, 姓名, 上次总分, 上次三科总分, 本次语文, 本次数学, 本次英语, 本次物理, 本次化学, 本次生物, 本次历史, 本次政治, 本次地理
            if (data.length < 2) {
                alert('Excel文件没有足够的数据，再检查下，要用旁边下载按钮的模版来导入');
                return;
            }
            const header = data[0];
            const requiredHeaders = ['学号', '姓名', '上次总分', '上次三科总分', '本次语文', '本次数学', '本次英语', '本次物理', '本次化学', '本次生物', '本次历史', '本次政治', '本次地理'];
            for (let i = 0; i < requiredHeaders.length; i++) {
                if (header[i] !== requiredHeaders[i]) {
                    alert(`Excel表头错误，预期第${i+1}列为"${requiredHeaders[i]}"。`);
                    return;
                }
            }
            // 填充数据
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (row.length < 13) continue; // 跳过不完整的行
                const id = parseInt(row[0]);
                const lastTotal = row[2] !== undefined ? row[2] : '';
                const lastThreeTotal = row[3] !== undefined ? row[3] : '';
                const currentChinese = row[4] !== undefined ? row[4] : '';
                const currentMath = row[5] !== undefined ? row[5] : '';
                const currentEnglish = row[6] !== undefined ? row[6] : '';
                const currentPhysics = row[7] !== undefined ? row[7] : '';
                const currentChemistry = row[8] !== undefined ? row[8] : '';
                const currentBiology = row[9] !== undefined ? row[9] : '';
                const currentHistory = row[10] !== undefined ? row[10] : '';
                const currentPolitics = row[11] !== undefined ? row[11] : '';
                const currentGeography = row[12] !== undefined ? row[12] : '';

                // 查找对应的输入框并填充
                const lastTotalInput = document.querySelector(`.last-total-score[data-id="${id}"]`);
                const lastThreeTotalInput = document.querySelector(`.last-three-total[data-id="${id}"]`);
                const currentChineseInput = document.querySelector(`.current-chinese[data-id="${id}"]`);
                const currentMathInput = document.querySelector(`.current-math[data-id="${id}"]`);
                const currentEnglishInput = document.querySelector(`.current-english[data-id="${id}"]`);
                const currentPhysicsInput = document.querySelector(`.current-physics[data-id="${id}"]`);
                const currentChemistryInput = document.querySelector(`.current-chemistry[data-id="${id}"]`);
                const currentBiologyInput = document.querySelector(`.current-biology[data-id="${id}"]`);
                const currentHistoryInput = document.querySelector(`.current-history[data-id="${id}"]`);
                const currentPoliticsInput = document.querySelector(`.current-politics[data-id="${id}"]`);
                const currentGeographyInput = document.querySelector(`.current-geography[data-id="${id}"]`);

                if (lastTotalInput) lastTotalInput.value = lastTotal;
                if (lastThreeTotalInput) lastThreeTotalInput.value = lastThreeTotal;
                if (currentChineseInput) currentChineseInput.value = currentChinese;
                if (currentMathInput) currentMathInput.value = currentMath;
                if (currentEnglishInput) currentEnglishInput.value = currentEnglish;
                if (currentPhysicsInput) currentPhysicsInput.value = currentPhysics;
                if (currentChemistryInput) currentChemistryInput.value = currentChemistry;
                if (currentBiologyInput) currentBiologyInput.value = currentBiology;
                if (currentHistoryInput) currentHistoryInput.value = currentHistory;
                if (currentPoliticsInput) currentPoliticsInput.value = currentPolitics;
                if (currentGeographyInput) currentGeographyInput.value = currentGeography;
            }
            alert('成绩已成功导入！  (*^o^*)  ');
        }

        // 下载模板
        document.getElementById('download-template').addEventListener('click', () => {
            const wb = XLSX.utils.book_new();
            const ws_data = [
                ["学号", "姓名", "上次总分", "上次三科总分", "本次语文", "本次数学", "本次英语", "本次物理", "本次化学", "本次生物", "本次历史", "本次政治", "本次地理"]
            ];
            students.forEach(student => {
                ws_data.push([student.id, student.name, "", "", "", "", "", "", "", "", "", "", ""]);
            });
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            XLSX.utils.book_append_sheet(wb, ws, "成绩模板");
            XLSX.writeFile(wb, '成绩模板.xlsx');
        });

        // 计算学分变化
        document.getElementById('calculate-credits').addEventListener('click', () => {

            // 获取所有学生的成绩
            const studentData = students.map(student => {
                const lastTotalInput = document.querySelector(`.last-total-score[data-id="${student.id}"]`);
                const lastThreeTotalInput = document.querySelector(`.last-three-total[data-id="${student.id}"]`);
                const currentChineseInput = document.querySelector(`.current-chinese[data-id="${student.id}"]`);
                const currentMathInput = document.querySelector(`.current-math[data-id="${student.id}"]`);
                const currentEnglishInput = document.querySelector(`.current-english[data-id="${student.id}"]`);
                const currentPhysicsInput = document.querySelector(`.current-physics[data-id="${student.id}"]`);
                const currentChemistryInput = document.querySelector(`.current-chemistry[data-id="${student.id}"]`);
                const currentBiologyInput = document.querySelector(`.current-biology[data-id="${student.id}"]`);
                const currentHistoryInput = document.querySelector(`.current-history[data-id="${student.id}"]`);
                const currentPoliticsInput = document.querySelector(`.current-politics[data-id="${student.id}"]`);
                const currentGeographyInput = document.querySelector(`.current-geography[data-id="${student.id}"]`);

                const lastTotalScore = lastTotalInput.value === '' ? null : parseFloat(lastTotalInput.value);
                const lastThreeTotal = lastThreeTotalInput.value === '' ? null : parseFloat(lastThreeTotalInput.value);
                const currentChinese = currentChineseInput.value === '' ? null : parseFloat(currentChineseInput.value);
                const currentMath = currentMathInput.value === '' ? null : parseFloat(currentMathInput.value);
                const currentEnglish = currentEnglishInput.value === '' ? null : parseFloat(currentEnglishInput.value);
                const currentPhysics = currentPhysicsInput.value === '' ? null : parseFloat(currentPhysicsInput.value);
                const currentChemistry = currentChemistryInput.value === '' ? null : parseFloat(currentChemistryInput.value);
                const currentBiology = currentBiologyInput.value === '' ? null : parseFloat(currentBiologyInput.value);
                const currentHistory = currentHistoryInput.value === '' ? null : parseFloat(currentHistoryInput.value);
                const currentPolitics = currentPoliticsInput.value === '' ? null : parseFloat(currentPoliticsInput.value);
                const currentGeography = currentGeographyInput.value === '' ? null : parseFloat(currentGeographyInput.value);

                return {
                    id: student.id,
                    name: student.name,
                    lastTotalScore: lastTotalScore,
                    lastThreeTotal: lastThreeTotal,
                    currentChinese: currentChinese,
                    currentMath: currentMath,
                    currentEnglish: currentEnglish,
                    currentPhysics: currentPhysics,
                    currentChemistry: currentChemistry,
                    currentBiology: currentBiology,
                    currentHistory: currentHistory,
                    currentPolitics: currentPolitics,
                    currentGeography: currentGeography,
                    currentTotalScore: null,
                    currentThreeTotal: null,
                    currentRank: null,
                    currentThreeRank: null,
                    rankChangeTotal: null,
                    rankChangeThree: null,
                    creditChange: null,
                    bonusDetails: []
                };
            });

            // 输入验证
            let invalidInput = false;
            studentData.forEach(s => {
                const scores = [
                    s.lastTotalScore, s.lastThreeTotal,
                    s.currentChinese, s.currentMath, s.currentEnglish,
                    s.currentPhysics, s.currentChemistry, s.currentBiology,
                    s.currentHistory, s.currentPolitics, s.currentGeography
                ];
                scores.forEach(score => {
                    if (score !== null && isNaN(score)) {
                        invalidInput = true;
                    }
                });
            });
            if (invalidInput) {
                alert('存在无效的成绩输入，请检查并重新输入。( Ĭ ^ Ĭ )');
                return;
            }

            // 计算本次总分和三科总分
            studentData.forEach(s => {
                if (
                    s.currentChinese !== null && s.currentMath !== null && s.currentEnglish !== null &&
                    s.currentPhysics !== null && s.currentChemistry !== null && s.currentBiology !== null &&
                    s.currentHistory !== null && s.currentPolitics !== null && s.currentGeography !== null
                ) {
                    s.currentTotalScore = s.currentChinese + s.currentMath + s.currentEnglish + s.currentPhysics + s.currentChemistry + s.currentBiology + s.currentHistory + s.currentPolitics + s.currentGeography;
                    s.currentThreeTotal = s.currentChinese + s.currentMath + s.currentEnglish;
                } else {
                    s.currentTotalScore = null;
                    s.currentThreeTotal = null;
                }
            });

            // 计算总分排名
            const sortedTotal = studentData
                .filter(s => s.currentTotalScore !== null)
                .sort((a, b) => b.currentTotalScore - a.currentTotalScore);

            sortedTotal.forEach((s, index) => {
                s.currentRank = index + 1;
            });

            // 计算三科总分排名
            const sortedThree = studentData
                .filter(s => s.currentThreeTotal !== null)
                .sort((a, b) => b.currentThreeTotal - a.currentThreeTotal);

            sortedThree.forEach((s, index) => {
                s.currentThreeRank = index + 1;
            });

            // 计算上次总分排名
            const sortedLastTotal = studentData
                .filter(s => s.lastTotalScore !== null)
                .sort((a, b) => b.lastTotalScore - a.lastTotalScore);

            sortedLastTotal.forEach((s, index) => {
                s.lastRankTotal = index + 1;
            });

            // 计算总分排名变化
            studentData.forEach(s => {
                if (s.lastTotalScore !== null && s.currentRank !== null) {
                    s.rankChangeTotal = s.lastRankTotal - s.currentRank;
                } else {
                    s.rankChangeTotal = null;
                }
            });

            // 计算上次三科总分排名
            const sortedLastThree = studentData
                .filter(s => s.lastThreeTotal !== null)
                .sort((a, b) => b.lastThreeTotal - a.lastThreeTotal);

            sortedLastThree.forEach((s, index) => {
                s.lastRankThree = index + 1;
            });

            // 计算三科排名变化
            studentData.forEach(s => {
                if (s.lastThreeTotal !== null && s.currentThreeRank !== null) {
                    s.rankChangeThree = s.lastRankThree - s.currentThreeRank;
                } else {
                    s.rankChangeThree = null;
                }
            });

            // 计算单科排名
            const subjects = ['currentChinese', 'currentMath', 'currentEnglish', 'currentPhysics', 'currentChemistry', 'currentBiology', 'currentHistory', 'currentPolitics', 'currentGeography'];
            subjects.forEach(subject => {
                const sortedSubject = studentData
                    .filter(s => s[subject] !== null)
                    .sort((a, b) => b[subject] - a[subject]);

                sortedSubject.forEach((s, index) => {
                    s[subject + 'Rank'] = index + 1;
                });
            });

            // 计算学分变化
            studentData.forEach(s => {
                let bonus = 0;
                s.bonusDetails = [];

                // 总分排名加分
                if (s.currentRank === 1) {
                    bonus += 8;
                    s.bonusDetails.push('总分第一名 +8分');
                } else if (s.currentRank >=2 && s.currentRank <=10) {
                    bonus += 5;
                    s.bonusDetails.push(`总分第${s.currentRank}名 +5分`);
                }

                // 三科总分排名加分
                if (s.currentThreeRank !== null && s.currentThreeRank >=1 && s.currentThreeRank <=10) {
                    bonus +=3;
                    s.bonusDetails.push('三科总分前十 +3分');
                }

                // 单科排名加分
                subjects.forEach(subject => {
                    const rank = s[subject + 'Rank'];
                    if (rank !== undefined && rank !== null) {
                        if (rank >=1 && rank <=5) {
                            bonus +=2;
                            s.bonusDetails.push(`${subject.replace('current','')}单科第${rank}名 +2分`);
                        } else if (rank >=6 && rank <=10) {
                            bonus +=1;
                            s.bonusDetails.push(`${subject.replace('current','')}单科第${rank}名 +1分`);
                        }
                    }
                });

                // 总分排名进步加分
                if (s.rankChangeTotal !== null) {
                    if (s.rankChangeTotal >=1 && s.rankChangeTotal <=10) {
                        bonus +=1;
                        s.bonusDetails.push('总分排名进步1-10名 +1分');
                    } else if (s.rankChangeTotal >=11 && s.rankChangeTotal <=20) {
                        bonus +=2;
                        s.bonusDetails.push('总分排名进步11-20名 +2分');
                    } else if (s.rankChangeTotal >=21 && s.rankChangeTotal <=30) {
                        bonus +=3;
                        s.bonusDetails.push('总分排名进步21-30名 +3分');
                    }
                }

                // 三科排名进步加分
                if (s.rankChangeThree !== null) {
                    if (s.rankChangeThree >=1 && s.rankChangeThree <=10) {
                        bonus +=1;
                        s.bonusDetails.push('三科排名进步1-10名 +1分');
                    } else if (s.rankChangeThree >=11 && s.rankChangeThree <=20) {
                        bonus +=2;
                        s.bonusDetails.push('三科排名进步11-20名 +2分');
                    } else if (s.rankChangeThree >=21 && s.rankChangeThree <=30) {
                        bonus +=3;
                        s.bonusDetails.push('三科排名进步21-30名 +3分');
                    }
                }

                // 限制学分变化不超过15分
                if (bonus > 15) {
                    bonus = 15;
                }

                s.creditChange = bonus > 0 ? `+${bonus}` : (bonus < 0 ? `${bonus}` : '0');
            });

            // 更新表格显示
            studentData.forEach(s => {
                const row = document.querySelector(`.last-total-score[data-id="${s.id}"]`).parentElement.parentElement;
                // 计算并显示本次总分
                const currentTotalCell = row.querySelector('.current-total-score');
                currentTotalCell.textContent = s.currentTotalScore !== null ? s.currentTotalScore : '缺考';

                // 计算并显示本次三科总分
                const currentThreeTotalCell = row.querySelector('.current-three-total');
                currentThreeTotalCell.textContent = s.currentThreeTotal !== null ? s.currentThreeTotal : '缺考';

                // 显示总分排名
                const currentRankCell = row.querySelector('.current-rank');
                currentRankCell.textContent = s.currentRank !== null ? s.currentRank : '-';

                // 显示三科排名
                const currentThreeRankCell = row.querySelector('.current-three-rank');
                currentThreeRankCell.textContent = s.currentThreeRank !== null ? s.currentThreeRank : '-';

                // 显示总分排名变化
                const rankChangeTotalCell = row.querySelector('.rank-change-total');
                if (s.rankChangeTotal === null) {
                    rankChangeTotalCell.textContent = '-';
                    rankChangeTotalCell.className = 'rank-change-total';
                } else {
                    if (s.rankChangeTotal > 0) {
                        rankChangeTotalCell.textContent = `↑ ${s.rankChangeTotal}`;
                        rankChangeTotalCell.className = 'rank-change-total rank-up';
                    } else if (s.rankChangeTotal < 0) {
                        rankChangeTotalCell.textContent = `↓ ${Math.abs(s.rankChangeTotal)}`;
                        rankChangeTotalCell.className = 'rank-change-total rank-down';
                    } else {
                        rankChangeTotalCell.textContent = '→ 0';
                        rankChangeTotalCell.className = 'rank-change-total rank-neutral';
                    }
                }

                // 显示三科排名变化
                const rankChangeThreeCell = row.querySelector('.rank-change-three');
                if (s.rankChangeThree === null) {
                    rankChangeThreeCell.textContent = '-';
                    rankChangeThreeCell.className = 'rank-change-three';
                } else {
                    if (s.rankChangeThree > 0) {
                        rankChangeThreeCell.textContent = `↑ ${s.rankChangeThree}`;
                        rankChangeThreeCell.className = 'rank-change-three rank-up';
                    } else if (s.rankChangeThree < 0) {
                        rankChangeThreeCell.textContent = `↓ ${Math.abs(s.rankChangeThree)}`;
                        rankChangeThreeCell.className = 'rank-change-three rank-down';
                    } else {
                        rankChangeThreeCell.textContent = '→ 0';
                        rankChangeThreeCell.className = 'rank-change-three rank-neutral';
                    }
                }

                // 显示学分变化
                const creditChangeCell = row.querySelector('.credit-change');
                if (s.creditChange === '0') {
                    creditChangeCell.textContent = '0';
                    creditChangeCell.className = 'credit-change';
                } else if (s.creditChange.startsWith('+')) {
                    creditChangeCell.textContent = s.creditChange;
                    creditChangeCell.className = 'credit-change credit-increase';
                } else {
                    creditChangeCell.textContent = s.creditChange;
                    creditChangeCell.className = 'credit-change credit-decrease';
                }
            });

            // 生成学分变化分布图
            generateCreditChart(studentData);

            // 显示详细加分原因
            showBonusDetails(studentData);

            alert('学分计算完成。');
        });

        // 导出结果为Excel
        document.getElementById('export-results').addEventListener('click', () => {
            const table = document.getElementById('scores-table');
            const headers = [];
            const subHeaders = [];
            const rows = [];
            // 获取表头
            const headerRows = table.querySelectorAll('thead tr');
            headerRows.forEach((headerRow, rowIndex) => {
                const cells = headerRow.querySelectorAll('th');
                cells.forEach(cell => {
                    if (rowIndex === 0) {
                        headers.push(cell.textContent.trim());
                    } else {
                        subHeaders.push(cell.textContent.trim());
                    }
                });
            });

            // 合并主表头和子表头
            const mergedHeaders = [];
            for (let i = 0; i < headers.length; i++) {
                if (headers[i].includes('成绩')) {
                    for (let j = 0; j < subHeaders.length; j++) {
                        if (subHeaders[j].includes(headers[i])) {
                            mergedHeaders.push(`${headers[i]}-${subHeaders[j]}`);
                        }
                    }
                } else {
                    mergedHeaders.push(headers[i]);
                }
            }

            // 获取表格数据
            const tableBody = table.querySelectorAll('tbody tr');
            tableBody.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach((cell, index) => {
                    // 学号 (0), 姓名 (1), 上次总分 (2), 上次三科总分 (3),
                    // 本次语文 (4), 本次数学 (5), 本次英语 (6), 本次物理 (7),
                    // 本次化学 (8), 本次生物 (9), 本次历史 (10), 本次政治 (11), 本次地理 (12),
                    // 当前总分 (13), 当前三科总分 (14), 当前总排名 (15), 当前三科排名 (16),
                    // 总分排名变化 (17), 三科排名变化 (18), 学分变化 (19)
                    if (index >=0 && index <=12) {
                        // 对于输入字段的值
                        const input = cell.querySelector('input');
                        rowData.push(input ? input.value : '');
                    } else if (index >=13 && index <=19) {
                        // 对于输出字段的值
                        rowData.push(cell.textContent.trim());
                    }
                });
                rows.push(rowData);
            });

            // 组合表头和表格数据
            const ws_data = [mergedHeaders, ...rows];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Results");
            XLSX.writeFile(wb, '学分计算结果.xlsx');
        });

        // 显示加分详细原因
        function showBonusDetails(studentData) {
            let detailsHTML = '<h3 class="text-center">学分加分原因</h3>';
            studentData.forEach(s => {
                if (s.creditChange !== '0' && s.creditChange !== '缺考') {
                    detailsHTML += `<p><strong>${s.name}:</strong> ${s.bonusDetails.join('， ')}，总共加分${s.creditChange}分。</p>`;
                }
            });
            document.getElementById('results-section').innerHTML = detailsHTML;
        }

        // 生成学分变化分布图
        let creditChart; // 全局变量
        function generateCreditChart(studentData) {
            const ctx = document.getElementById('creditChart').getContext('2d');
            const creditChanges = studentData.map(s => {
                if (s.creditChange.startsWith('+')) {
                    return parseInt(s.creditChange.slice(1));
                } else if (s.creditChange.startsWith('-')) {
                    return parseInt(s.creditChange);
                } else {
                    return 0;
                }
            });
            const creditLabels = [...new Set(creditChanges)].sort((a, b) => a - b);
            const creditCounts = creditLabels.map(label => creditChanges.filter(c => c === label).length);
            // 如果图表已经存在，把它销毁
            if (creditChart) {
                creditChart.destroy();
            }
            creditChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: creditLabels.map(label => label > 0 ? `+${label}` : label),
                    datasets: [{
                        label: '学分变化人数',
                        data: creditCounts,
                        backgroundColor: creditLabels.map(label => {
                            if (label > 0) return 'rgba(75, 192, 192, 0.6)'; // 绿色
                            if (label < 0) return 'rgba(255, 99, 132, 0.6)'; // 红色
                            return 'rgba(201, 203, 207, 0.6)'; // 灰色
                        }),
                        borderColor: creditLabels.map(label => {
                            if (label > 0) return 'rgba(75, 192, 192, 1)';
                            if (label < 0) return 'rgba(255, 99, 132, 1)';
                            return 'rgba(201, 203, 207, 1)';
                        }),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '人数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '学分变化'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: false,
                            text: '学分变化分布图'
                        }
                    }
                }
            });
        }

        // 初始化表格
        initializeTable();
    </script>

</body>
</html>
